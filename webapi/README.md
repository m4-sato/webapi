# MEMO


- FastAPIの起動
```bash
uv run fastapi dev
```


## Azure関係

### RAGとは？
- 大規模援護モデルが知らない情報を外部の検索システムで検索し、その検索結果を情報源として回答する手法のこと
- 用語
  - グラウディング
  　大規模言語モデルに外部情報を連携することをグラウディングと呼ぶ
  - オーケストレータ
    ユーザーの質問を受けて関連するドキュメントを検索したり、大規模言語モデルに回答作成の指示を与えたりするモジュールはオーケストレータと呼ぶ
- メリット
  - モデルが最新活信頼性の高い情報にアクセスできること
  - ユーザーがモデルの参照情報源を認識でき、生成結果の正確さを確認・検証できること。⇒ハルシネーション対策
- 情報源
  - [RAG論文](https://arxiv.org/abs/2005.11401)
  - [GitHubサンプルリポジトリ](https://github.com/shohei1029/book-azureopenai-sample)
  - [AzureDemo](https://github.com/Azure-Samples/azure-search-openai-demo)

- 検索システム
  - インターネット検索
  - ドキュメント検索(ベクトル検索)
  - データベース検索(RDB)

- 注意事項
  - ドキュメントの文字数について
  - 文章検索の場合

### Azure AI Searchとは
- PaaS
- Azure AI Searchを使えばドキュメント内容をindexとして登録しておき、検索時はインデックスからドキュメントを引き当てるので高速に検索することができる。
  - 処理フロー
    - step1. インデックス作成
    - step2. ドキュメント検索
- メリット
  - 多様なデータソースとフォーマットの対応
    - PDFやテーブルデータ、JSONなどの多種多様なデータフォーマットに対応している。
    - Blob StorageやAzure CosmosDB等様々なデータソースにも対応
  - スケーラビリティ
    インデックスのパーティション数やレプリカ数を調整し、負荷に応じて柔軟にスケールアウト可能
  - 豊富な検索機能
  　フルテキスト検索に加え、Bingの検索エンジンで使用されるAI搭載のセマンティック検索やベクトル検索にも対応

#### インデックス作成の流れ
- インデックス作成の方法には2つ
  - 1. インデクサーの利用
    - Azure Blob StorageなどのAzure AI Searchが対応しているデータソースを指定する。
    - インデクサーは定期的にデータソースをスキャンし、インデックスを更新する。（Pull型）
    - PDFをテキストに変換する処理も内部で自動的に実行される。
  - 2. APIの利用
    - インデックスのレコード内容を直接APIリクエストのボディとして送信し、インデックスを作成する。（Push型）
    - ドキュメントからテキストを抽出する処理はユーザー側で行う必要はあるが、Pull型に比べてリアルタイムなインデックスの更新が可能
- インデックス付与について
  - json,csvは各行や項目が1レコードとして登録
  - その他Word、pdf,Excel,PowerPoint等は1ドキュメントに対して1レコードのインデックスが作成される。
- スキルセットについて
  インデクサーによって取得したテキストに対し、スキルセットを活用することでキーフレーズ抽出などさまざまな処理を行うことが可能
  - カスタムエンティティの参照
  - キーフレーズ抽出
  - エンティティの認識(v3)
  - PII(個人情報)検出
  - テキスト分割
  - テキスト翻訳
  - 画像分析
- アナライザーについて
  - 検索対象のフィールドは、アナライザーによってテキストから単語に分割されてからインデックスに保存される。
  - アナライザーはインデックス作成時に利用されるだけでなく、クエリ実行時にも利用される。
  - アナライザーは単に単語の分割だけでなく、以下の処理も行う。
    - ストップワードの削除
    - フレーズやハイフン付きの単語を個々の要素に分解
    - 大文字の単語を小文字に変換
    - 単語をその基本形に簡略化し、異なる時制でも一致を容易にする
  - 日本語ではja.lucene OR ja.microsoft
- インデックスのスキーマ
  - key
    インデックス内のドキュメントの一意識別子
  - searchable
    フルテキスト検索可能
  - filterable
    フィルタークエリで利用可能
  - sortable
    デフォルトでは結果スコアで並べ替えるか、フィールドに基づいて並べ替えが可能
  - facetable
    カテゴリ別のヒット数として検索可能に含めることが可能
  - retrievable
  　検索結果に含めか否か
- チャンク分割
- ドキュメント検索
  - フルテキスト検索（BM25アルゴリズム）
    - step1. ユーザーがクエリを発行すると、クエリパーサーが構文を解析、検索文を抜き出す
    - step2. アナライザーが検索文を単語に分解
    - step3. 検索を実行し、検索スコアに基づいて結果をソート
  - ベクトル検索
    - Embeddingを活用したベクトル検索
    - 類似度計算にはcos類似度が一般的に使用される
    - 検索アルゴリズム
      基本的には1.を利用し、検索精度が悪くて小規模データの場合は2.に切り替える。
      - 1. HNSW(Hierarchi Navigative Small World) 
        階層グラフ構造により高速でスケーラブルな検索を実現。検索精度と計算コストのトレードオフを調整
      - 2. KNN(Exhaustive K-nearest neighbors)
        全てのデータ点の類似度を計算。
  - セマンティック検索
  　フルテキストで検索された結果に対し、独自のAIモデルによって関連する結果を並び替える手法
  - ハイブリッド検索
  　ハイブリッド検索とセマンティックランク付けの検索手法はほとんどのクエリでかなり高い精度の検索結果を実現されていることが報告されている。
